---
title: "SQLAlchemyã§å‹ãƒã‚§ãƒƒã‚¯ã‚’ãŒã‚“ã°ã‚‹"
emoji: "ğŸ»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "sqlalchemy"]
published: true
---

SQLAlchemyã¯é•·ã‚‰ããŠä¸–è©±ã«ãªã£ã¦ã‚‹ã‘ã©ã€å‹ãƒã‚§ãƒƒã‚¯ã«å¯¾ã™ã‚‹ç†è§£ãŒå¾®å¦™ã ã£ãŸã®ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

## ã‚ˆãã‚ã‚‹èª¤è§£

#### é™çš„å‹ãƒã‚§ãƒƒã‚¯ã¨å®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯

Pythonã®å‹ãƒã‚§ãƒƒã‚¯ã«è©³ã—ããªã„äººã€ç‰¹ã«é™çš„å‹ä»˜ã‘è¨€èªã‹ã‚‰æ¥ãŸäººã«ã‚ˆãã‚ã‚‹èª¤è§£ãªã‚“ã§ã™ãŒã€SQLAlchemyã‚’å«ã‚ã»ã¨ã‚“ã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯é™çš„ãªå‹ãƒã‚§ãƒƒã‚¯ã—ã‹æä¾›ã—ã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«PEP484ã§å‹ã‚’æŒ‡å®šã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã€mypyãŒã‚³ãƒ¼ãƒ‰ã‚’æ¤œæŸ»ã—ã¦å‹ã‚¨ãƒ©ãƒ¼ã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚
```python
@dataclass
class Foo:
    i: int

Foo('10') # <== Argument 1 to "Foo" has incompatible type "str"; expected "int"
```

ã—ã‹ã—ã€å‹å®£è¨€ãŒé–“é•ã£ã¦ã„ãŸã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œæ™‚ã«é–“é•ã£ãŸå‹ãŒæ¥ãŸã¨ã—ã¦ã‚‚mypyã¨pythonã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã¯ä½•ã‚‚æ•™ãˆã¦ãã‚Œã¾ã›ã‚“ã€‚

```python
Foo(json.loads('"10"')) # mypyã®ã‚¨ãƒ©ãƒ¼ã¯å‡ºãªã„
```


é™çš„å‹ãƒã‚§ãƒƒã‚¯ã¨å®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ãŒæ¬²ã—ã„å ´åˆã¯ç¾çŠ¶ãã†ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(e.g. [pyserde](https://github.com/yukinarit/pyserde), [beartype](https://github.com/beartype/beartype), [pydantic](https://pydantic-docs.helpmanual.io/))ã‚’é¸å®šã™ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€[pyserde](https://github.com/yukinarit/pyserde)ã§ã¯JSONã‹ã‚‰ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹éš›ã«å®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ãŒå¯èƒ½ã§ã™ã€‚

```python
@serde
@dataclass
class Foo
    i: int

# serde.compat.SerdeError: Foo.i is not instance of int
from_json(Foo, '{"i": "10"}', type_check=Strict)
```

æœ¬è¨˜äº‹ã§ã¯SQLALchemyã§é™çš„å‹ãƒã‚§ãƒƒã‚¯ã‚’ãŒã‚“ã°ã‚‹æ–¹æ³•ã‚’ä¸­å¿ƒã«è§£èª¬ã—ã€æœ€å¾Œã«å®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†æ–¹æ³•ã‚‚ææ¡ˆã—ã¦ã¿ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—


#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

* SQLAlchemy 1.4

sqlalchemyã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«`mypy`extrasã‚’æŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚ã™ã‚‹ã¨ã€[sqlalchemy2-stubs](https://github.com/sqlalchemy/sqlalchemy2-stubs)ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚sqlalchemy2-stubsã¯SQLAlchemyã®ã‚³ãƒ¼ãƒ‰ã®å‹æƒ…å ±ã‚’æä¾›ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚
```
pip install sqlalchemy[mypy]
```

* SQLAlchemy 2.X

```
pip install git+https://github.com/sqlalchemy/sqlalchemy.git
```
SQLAlchemy 2ç³»ã§ã¯Python 3.6ä»¥ä¸Šã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã¦ã„ã‚‹ã®ã§ã€sqlalchemy2-stubsã¯è¦ã‚‰ãªããªã‚‹ã‚ˆã†ã§ã™ã€‚


#### mypyã®è¨­å®š

mypyã®SQLALchemyãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚ãªãœãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã‹ã¨ã„ã†ã¨ã€mypyã£ã¦å‹ãƒã‚§ãƒƒã‚¯æ™‚ã«å®Ÿéš›ã«pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€SQLAlchemyã®ã‚ˆã†ã«å®Ÿè¡Œæ™‚ã«å‹ã‚’ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã—ã¦ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã†ã¾ãå‹ãƒã‚§ãƒƒã‚¯ã§ããªã„ã‚“ã§ã™ã‚ˆã­ã€‚ã ã‹ã‚‰mypyãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æä¾›ã—ã¦ã€SQLAlchemyã®ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã—ã¦ã‚‹éƒ¨åˆ†ã‚’ã¡ã‚ƒã‚“ã¨å‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚ã’ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚pydanticã‚‚åŒã˜ã‚ˆã†ã«[mypy plugin](https://pydantic-docs.helpmanual.io/mypy_plugin/)ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

```ini
[mypy]
plugins = sqlalchemy.ext.mypy.plugin
```

ã¡ãªã¿ã«SQLAchemyä½œè€…ã®Mike Bayeræ°ã«ã‚ˆã‚‹ã¨ã€mypyãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãƒ¡ãƒ³ãƒ†ã™ã‚‹ã®ã¯ã‚ã£ã¡ã‚ƒå¤§å¤‰ã ãã†ã§ã™ã€‚

> Mypy plugins are extremely difficult to develop, maintain and test, as a Mypy plugin must be deeply integrated with Mypyâ€™s internal datastructures and processes, which itself are not stable within the Mypy project itself. The SQLAlchemy Mypy plugin has lots of limitations when used with code that deviates from very basic patterns which are reported regularly.

https://docs.sqlalchemy.org/en/14/orm/extensions/mypy.html

## ãƒ¢ãƒ‡ãƒ«ã«ã¡ã‚ƒã‚“ã¨å‹ã‚’æŒ‡å®šã™ã‚‹

#### å…¨ã¦ã®ã‚«ãƒ©ãƒ ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Optionalã«ãªã‚‹

ä»¥ä¸‹ã®ãƒ¢ãƒ‡ãƒ«ã§ã€NOT NULLã®`name`ã¨`detail`ã‚„PrimaryKeyãª`id`ã¯ç›´æ„Ÿçš„ã«ã¯Non Optionalã«ãªã£ã¦ã»ã—ã„ã¨ã“ã‚ã§ã™ãŒã€SQLAlchemyã§ã¯[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å…¨ã¦`Optional`ã«ãªã‚Šã¾ã™](https://docs.sqlalchemy.org/en/14/orm/extensions/mypy.html#introspection-of-columns-based-on-typeengine)ã€‚

```python
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)
    detail = Column(JSON, nullable=False)
    money = Column(Numeric, nullable=True)
    updated_at = Column(DateTime, nullable=False)

user = User(id=None)   # <= mypyã§ã¯ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã§ããªã„
```

ã“ã®ä»•æ§˜ã¯å¾®å¦™ã ãªã¨ã¯æ€ã„ã¾ã™ãŒã€autoincrementã®å ´åˆã¯PrimaryKeyã§ã‚‚`Optional`ã«ãªã£ã¦ã»ã—ã‹ã£ãŸã‚Šã‚‚ã™ã‚‹ã®ã§ã—ã‚‡ã†ãŒãªã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

#### SQLAlchemyã®å‹ã«ã¯å¹…ãŒã‚ã‚‹

ä¸Šã®ä¾‹ã ã¨`money`ã¯`Numeric`ã§ã™ãŒã€mypyãŒèªè­˜ã™ã‚‹å‹ã¯`Optional[Union[float, Decimal]]`ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚ãªãœ`float`ã¨`Decimal`ã®äºŒã¤å€™è£œãŒã‚ã‚‹ã‹ã¨ã„ã†ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«`asdecimal`ãŒTrue/Falseã§SQLAlchemyãŒè¿”ã™å‹ãŒå¤‰ã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

```python
    # Decimalã«ãªã‚‹
    money = Column(Numeric, nullable=True)
    # floatã«ãªã‚‹
    money = Column(Numeric(asdecimal=False), nullable=True)
```

#### ã‚¯ãƒ©ã‚¹å®šç¾©ã«æœŸå¾…ã™ã‚‹å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹

å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ`Optional`ã§`Union`ã ã¨ä½•ã¨ã‚‚ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã—ã¥ã‚‰ã„ã§ã™ã‚ˆã­ã€‚ SQLAlchemyã¯ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹å®šç¾©æ™‚ã«PEP484ã‚¹ã‚¿ã‚¤ãƒ«ã§å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã§ãã‚‹ã®ã§ã€è‡ªåˆ†ãŒæœŸå¾…ã™ã‚‹å‹ã‚’æŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚

```python
class User(Base):
    __tablename__ = "users"

    id: int = Column(Integer, primary_key=True)
    name: str = Column(String, nullable=False)
    detail: dict[str, Any] = Column(JSON, nullable=False)
    money: Optional[Decimal] = Column(Numeric, nullable=True)
    updated_at: datetime = Column(DateTime, nullable=False)
```

ã“ã†ã™ã‚Œã°ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã¯mypyã§å‹ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```python
user = User(id=None)   # <= Argument "id" to "User" has incompatible type "None"; expected "int"
```

## ã‚¯ã‚¨ãƒªã§ã¡ã‚ƒã‚“ã¨å‹ã‚’æŒ‡å®šã™ã‚‹

`1.4.39`æ™‚ç‚¹ã§ã¯Queryã®APIã§ä¸Šæ‰‹ãå‹ã‚’èªè­˜ã—ã¦ãã‚Œãªã•ãã†ãªã®ã§ã€è‡ªåˆ†ã§æŒ‡å®šã™ã‚‹ã—ã‹ãªã•ãã†ã§ã™

```python
u: User = s.query(User).one()
```

æˆ»ã‚Šå€¤ã§è¿”ã™ä»¥å¤–ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æŒ‡å®šã§ãã¾ã™ã€‚
```python
u: User
for u in s.query(User):
    ...
```

SQLAlchemyã®ã‚³ãƒ¼ãƒ‰ã§å‹ã‚’æ˜ç¤ºã—ã¦ãã‚Œã‚Œã°æ¥½ãªã‚“ã§ã™ã‘ã©ã­ã€‚ã€‚SQLAlchemy v2ã§ã¯ã“ã®è¾ºãŒ[ã ã„ã¶å‘ä¸Šã•ã‚Œãã†](https://github.com/sqlalchemy/sqlalchemy2-stubs/issues/214)ãªã®ã§æœŸå¾…ã€‚

## ã‚„ã£ã±ã‚Šå®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ã‚‚ã»ã—ã„

:::message
NOTE: SQLAlchemyã«ãŠã„ã¦ã‚‚å®Ÿè¡Œæ™‚ã«ãƒã‚§ãƒƒã‚¯ãŒä½•ã‚‚ãªã„ã¨ã„ã†ã‚ã‘ã§ã¯ãªã„ã§ã™ã€‚SQLAlchemy(ã¨ã„ã†ã‹DB API?)ã¯ç•°ãªã‚‹å‹ã®å€¤ãŒãã¦ã‚‚äº’æ›æ€§ã®ã‚ã‚‹å‹ã§ã‚ã‚Œã°å—ã‘ä»˜ã‘ã¦ãã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«Decimalå‹ã«`str`ã‚’å…¥ã‚Œã¦ã‚‚`int`ã§ã‚‚`float`ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãšã«ä¸Šæ‰‹ãã‚„ã£ã¦ãã‚Œã¾ã™ã€‚

```python
u = User(money="1000")
```

ä¸€æ–¹ã§æ•°å€¤ã§ã¯ãªã„æ–‡å­—åˆ—ã‚’å…¥ã‚Œã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ãã‚Œã¾ã™ã€‚

```python
u = User(money="aaaa")
```

ã“ã®æŒ™å‹•ã¯ã“ã‚Œã§å¬‰ã—ã„ã®ã§ã™ãŒã€ã‚„ã£ã±ã‚Šã‚‚ã£ã¨å³æ ¼ãªå‹ãƒã‚§ãƒƒã‚¯ãŒæ¬²ã—ããªã‚Šã¾ã™ã€‚
:::

ã‚„ã¯ã‚Šå®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ã‚‚ã‚ã‚‹ã¨ä¾¿åˆ©ãªã®ã§ã€æœ€ã‚‚è‰¯ã•ãã†ãªã‚„ã‚Šæ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

[SQLAlchemyã®ãƒ¢ãƒ‡ãƒ«ã¯`dataclass`ã§ã‚‚å®šç¾©ã§ãã¾ã™ã€‚](https://docs.sqlalchemy.org/en/20/changelog/whatsnew_20.html#native-support-for-dataclasses-mapped-as-orm-models)ã“ã®æ–¹æ³•ã‚’ä½¿ã†åˆ©ç‚¹ã¨ã—ã¦ã¯`dataclass`ã®æ©Ÿèƒ½ã‚’ä½¿ãˆã‚‹ã“ã¨ã¨ã€`dataclass`ã«å¯¾å¿œã—ãŸæ§˜ã€…ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ãˆã‚‹ã“ã¨ã«ã‚ã‚Šã¾ã™ã€‚

```python
@mapper_registry.mapped
@beartype
@dataclass
class User:
    __table__ = Table(
        "users",
        mapper_registry.metadata,
        Column("id", Integer, primary_key=True),
        Column("name", String, nullable=False),
        Column("detail", JSON, nullable=False),
        Column("money", Numeric, nullable=True),
        Column("updated_at", DateTime, nullable=False)
    )
    id: Optional[int]
    name: str
    detail: dict[str, Any]
    money: Optional[Decimal]
    updated_at: datetime
```

å®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ã‚’æä¾›ã™ã‚‹[beartype](https://github.com/beartype/beartype)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

![](/images/8cf10358be0086/beartype.png)

beartypeã¯dataclassã«å¯¾å¿œã—ã¦ãŠã‚Šã€`@beartype`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§å®Ÿè¡Œæ™‚å‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨mypyã«ã‚ˆã‚‹é™çš„å‹ãƒã‚§ãƒƒã‚¯ã ã‘ã§ãªãã€å®Ÿè¡Œæ™‚ã«ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼
```python
u = User(id=None, name="foo", detail={}, money=1000, updated_at=datetime.now())
```

* mypyã‚¨ãƒ©ãƒ¼
```python
error: Argument "money" to "User" has incompatible type "int"; expected "Optional[Decimal]"
```
* å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼
```python
beartype.roar.BeartypeCallHintParamViolation: @beartyped __create_fn__.__init__() parameter money=1000 violates type hint typing.Optional[decimal.Decimal], as 1000 not <protocol "builtins.NoneType"> or <protocol "decimal.Decimal">.
```

## SQLAlchemy 2.0ã«æœŸå¾…

[SQLAlchemy 2.0](https://docs.sqlalchemy.org/en/20/changelog/whatsnew_20.html)ã§ã¯å‹å‘¨ã‚ŠãŒã ã„ã¶å¼·åŒ–ã•ã‚Œã¦ã‹ãªã‚ŠæœŸå¾…ã§ããã†ã§ã™ã€‚2.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸé ƒã«è‰²ã€…è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
