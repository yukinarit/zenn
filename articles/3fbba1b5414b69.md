---
title: "å‹ãƒ™ãƒ¼ã‚¹ã§æ°—æŒã¡ã‚ˆãCLIã‚’æ›¸ã‘ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µoppapiã‚’ä½œã£ã¦ã„ã¾ã™"
emoji: "ğŸ¤©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "CLI"]
published: true
---

ã“ã®è¨˜äº‹ã¯[Python Advent Calendar 2021](https://qiita.com/advent-calendar/2021/python) 17æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

## Motivation

ç­†è€…ã¯æ™®æ®µRustã¨Pythonã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒå¤šã„ã®ã§ã™ãŒã€Rustã«ã¯[structopt](https://github.com/TeXitoi/structopt) [^1]ã¨ã„ã†ã¨ã¦ã‚‚ã¨ã¦ã‚‚ä¾¿åˆ©ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’å‹ã‚’ä½¿ã£ã¦æ°—æŒã¡ã‚ˆãæ›¸ã‘ã¾ã™ã€‚

### `structopt`

Rustã®`structopt`ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«structã«attributeã‚’ä»˜ã‘ã‚‹ã¨ã€structãŒã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã¨ãªã‚Šã€ å‹ã¨attributeã‹ã‚‰æ§˜ã€…ãªæ©Ÿèƒ½ã‚’æŒã£ãŸãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚Œã¾ã™ã€‚

```rust
#[derive(StructOpt, Debug)]
#[structopt(name = "basic")]
struct Opt {
    #[structopt(short, long)]
    debug: bool,

    #[structopt(short, long, parse(from_os_str))]
    output: PathBuf,

    #[structopt(short = "c", long)]
    nb_cars: Option<i32>,

    #[structopt(name = "FILE", parse(from_os_str))]
    files: Vec<PathBuf>,
}
```

### `click`

ç­†è€…ã¯ä»¥å‰ã‹ã‚‰[click](https://github.com/pallets/click)ã¨ã„ã†pythonã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ã‚ˆãä½¿ã£ã¦ã„ã¾ã—ãŸã€‚`click`ã‚’ä½¿ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ä½¿ã£ã¦å®£è¨€çš„ã«ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚Œã¦ä¾¿åˆ©ãªã®ã§ã™ãŒã€è§£æçµæœãŒå€‹åˆ¥ã«å¤‰æ•°ã«ãªã‚‹ã®ã¨ã€mypyã‚„LSPã§å‹ã‚’èªè­˜ã—ã¦ã‚‚ã‚‰ã†ã«ã¯ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã ã‘ã§ãªãå¤‰æ•°å´ã«ã‚‚å‹å®£è¨€ãŒå¿…è¦ã ã£ãŸã‚Šã§é¢å€’ã ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚

```python
@click.command()
@click.option("--count", default=1, help="Number of greetings.")
@click.option("--name", prompt="Your name", help="The person to greet.")
def hello(count, name):
    ...
```

ã¾ãŸã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¤šããªã‚‹ã¨è‡ªç„¶ã¨classã«ã¾ã¨ã‚ãŸããªã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ¥é€”dataclassã‚’ä½œã‚‹ã®ã‚‚é¢å€’ã§ã—ãŸã€‚

```python
@dataclass
class Opt:
    count: int
    name: str

@click.command()
@click.option("--count", default=1, help="Number of greetings.")
@click.option("--name", prompt="Your name", help="The person to greet.")
def hello(**kwargs):
    opt = Opt(**kwargs)
    ...
```

## `oppapi`

ä»¥ä¸Šã®ä¸æº€ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«[`oppapi`](https://github.com/yukinarit/oppapi) (ãŠã£ã±ã£ã´ãƒ¼)ã¨ã„ã†æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚Šå§‹ã‚ã¾ã—ãŸã€‚`oppapi`ã¯[dataclasses](https://docs.python.org/3/library/dataclasses.html)ã¨[argparse](https://docs.python.org/3/library/argparse.html)ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ãŠã‚Šã€
* `structopt`ã®ã‚ˆã†ã«å‹ã‚’åˆ©ç”¨ã—ã¦æ°—æŒã¡ã‚ˆãCLIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ›¸ã‘ã‚‹ã“ã¨
* è¤‡é›‘ãªè¨­å®šã‚’ã—ãªãã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹•ã§ã‚„ã‚ŠãŸã„ã“ã¨ãŒã§ãã‚‹

ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚åå‰ã¯optionã£ã½ã„å’Œåã§ãƒ†ã‚­ãƒˆãƒ¼ã«æ±ºã‚ã¾ã—ãŸã€‚

![](/images/3fbba1b5414b69/oppapi-logo.png)

https://github.com/yukinarit/oppapi

## Usage

ä»¥ä¸‹ã®ã‚ˆã†ã«classå®šç¾©ã«`@oppapi`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ã‘ã¾ã™ã€‚

```python
from typing import Optional
from oppapi import from_args, oppapi

@oppapi
class Opt:
    """
    Option parser using oppapi
    """

    host: str
    """ This will be a positional argument of type `str` """

    port: Optional[int] = 8000
    """ This will be an option argument of type `int` """

opt = from_args(Opt)
print(opt)
```

`from_args(Opt)`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`Opt`ã‚¯ãƒ©ã‚¹ã®å‹å®£è¨€ã«åŸºã¥ã„ã¦ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒ¼ã‚µãƒ¼ã«ã¯ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚
* ã‚¯ãƒ©ã‚¹ã®docstringã‹ã‚‰ãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒ˜ãƒ«ãƒ—ã‚’ç”Ÿæˆã™ã‚‹
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®docstringã‹ã‚‰å¼•æ•°ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®ãƒ˜ãƒ«ãƒ—ã‚’ç”Ÿæˆã™ã‚‹
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¼•æ•°(Positional Argument)ã«ãªã‚‹
* `Optional`ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°(Option Argument)ã«ãªã‚‹

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒ˜ãƒ«ãƒ—ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚
```
$ python simple.py -h
usage: simple.py [-h] [-p PORT] host

Option parser using oppapi

positional arguments:
  host                  Primitive type will be positional argument

optional arguments:
  -h, --help            show this help message and exit
  -p PORT, --port PORT  Optional type will be option argument
  ```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å¼•æ•°ã‚’ä¸ãˆã¦ã‚³ãƒãƒ³ãƒ‰è§£æãŒæˆåŠŸã™ã‚‹ã¨ã€è§£æçµæœãŒ`Opt`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚

```
$ python simple.py 127.0.0.1 -p 80
Opt(host='127.0.0.1', port=80)
```

## ä½¿ãˆã‚‹å‹

* Primitives (`int`, `float`, `str`, `bool`)
* Containers (`List`, `Tuple`)
* `typing.Optional`
* [`enum`](https://github.com/yukinarit/oppapi/blob/main/examples/choice.py)
* [`datetime`](https://github.com/yukinarit/oppapi/blob/main/examples/mod_datetime.py)
* [`decimal`](https://github.com/yukinarit/oppapi/blob/main/examples/mod_decimal.py)
* [`ipaddress`](https://github.com/yukinarit/oppapi/blob/main/examples/mod_ipaddress.py)
* [`pathlib`](https://github.com/yukinarit/oppapi/blob/main/examples/mod_path.py)
* [`uuid`](https://github.com/yukinarit/oppapi/blob/main/examples/mod_uuid.py)

```python
@oppapi
class Opt:
    datetime: datetime
    date: Optional[date]
    time: Optional[time]

opt = from_args(Opt)
print(opt)
```

ä¾‹ãˆã°`datetime`, `date`, `time`ã‚’ä½¿ã£ãŸ`Opt`ã‚¯ãƒ©ã‚¹ã§ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³è§£æã‚’ã™ã‚‹ã¨ã€ã¡ã‚ƒã‚“ã¨æ­£ã—ã„å‹ã§è¿”ã£ã¦ãã¦ãã‚Œã¾ã™ã€‚
```
$ python mod_datetime.py 2021-10-23T11:11:11 -d 2021-10-23 -t 11:11:11
Opt(datetime=datetime.datetime(2021, 10, 23, 11, 11, 11), date=datetime.date(2021, 10, 23), time=datetime.time(11, 11, 11))
```

## ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®shortã¨longã®è¨­å®š

## `short`/`long`åã®å¤‰æ›´

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ•ãƒ©ã‚°åãŒç”Ÿæˆã•ã‚Œã¾ã™ãŒã€`short`, `long`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã‚’ä»˜ã‘ã‚Œã°ã€ä»»æ„ã®`short`/`long`åã«å¤‰æ›´ã§ãã¾ã™ã€‚

```python
from typing import Optional
from oppapi import from_args, oppapi, field

@oppapi
class Opt:
    host: Optional[str] = field(short="-n", long="--hostname")
```

## `enum`

`enum.Enum`ã€`enum.IntEnum`ã‚’è¨­å®šã™ã‚‹ã¨ã€è‡ªå‹•ã§[choices](https://docs.python.org/3/library/argparse.html#choices)ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ãã‚Œã¾ã™ã€‚

```python
class Food(Enum):
    A = "Apple"
    B = "Beer"
    C = "Chocolate"

class Price(IntEnum):
    A = 10
    B = 20
    C = 30

@oppapi
class Opt:
    food: Food
    price: Optional[Price]
```

usageã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã€
```
positional arguments:
  {Apple,Beer,Chocolate}

optional arguments:
  -h, --help            show this help message and exit
  -p {10,20,30}, --price {10,20,30}
```

ã‚³ãƒãƒ³ãƒ‰å¼•æ•°è§£æã™ã‚‹ã¨ã¡ã‚ƒã‚“ã¨Enumå‹ã«æˆ»ã—ã¦ãã‚Œã¾ã™ã€‚

```python
$ python choice.py Apple --price 20
Opt(food=<Food.A: 'Apple'>, price=<Price.B: 20>)
```

## `List`/`Tuple`

`List`ã¯ä»»æ„é•·ã®å¼•æ•°(`nargs="+"`)ã«ãªã‚Šã€`Tuple`ã¯å›ºå®šé•·ã®å¼•æ•°(`nargs=NUM`)ã«ãªã‚Šã¾ã™ã€‚
```python
@oppapi
class Opt:
    values: List[int]
    opts: Optional[Tuple[int, str, float, bool]]
```

```
$ python nargs.py 1 2 3 --opts 10 foo 10.0 True
Opt(values=[1, 2, 3], opts=(10, 'foo', 10.0, True))
```

## SubCommand

**â€»ã¾ã ã‹ãªã‚Šé™å®šçš„ã«ã—ã‹å‹•ã‹ãªã„ã§ã™**

`typing.Union`ã‚’ä½¿ã£ã¦ä»–ã®`oppapi`ã‚¯ãƒ©ã‚¹ã‚’ãƒã‚¹ãƒˆã™ã‚‹ã¨subcommandã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
from typing import Optional, Union
from oppapi import from_args, oppapi

@oppapi
class Foo:
    a: int

@oppapi
class Bar:
    b: Optional[int]

@oppapi
class Opt:
    cmd: str
    sub: Union[Foo, Bar]
```

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã«`"foo"`ã‚’ä¸ãˆã‚‹ã¨`Foo`ã«ãªã£ã¦ãã‚Œã¾ã™ã€‚

```python
$ python subcommand.py hello foo 10
Opt(cmd='hello', sub=Foo(a=10)) True
```

ä»Šåº¦ã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã«`"bar"`ã‚’ä¸ãˆã‚‹ã¨`Bar`ã«ãªã£ã¦ãã‚Œã¾ã™ã€‚

```python
$ python subcommand.py hello bar -b 100
Opt(cmd='hello', sub=Bar(b=100)) False
```

## ã©ã†ã‚„ã£ã¦å‹•ã„ã¦ã„ã‚‹ã‹

ã–ã£ãã‚Šã“ã‚“ãªæµã‚Œã«ãªã‚Šã¾ã™ã€‚

```mermaid
graph TB
    A[dataclasså®šç¾©ã‹ã‚‰docstringã‚’å–å¾—ã™ã‚‹] --> B[docstringã¨å‹æƒ…å ±ã‹ã‚‰argparse.Parserã‚’ä½œã‚‹]
    B --> C[parserã‚’èµ·å‹•ã—ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³è§£æã‚’ã™ã‚‹]
    C --> D[è§£æçµæœã‚’classã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹]
```

### dataclasså®šç¾©ã‹ã‚‰docstringã‚’å–å¾—ã™ã‚‹

`structopt`ã®æ¬ ã‹ã›ãªã„æ©Ÿèƒ½ã¯ã€structã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®ãƒ˜ãƒ«ãƒ—ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã—ãŸã€‚`dataclasses`ã§æä¾›ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã®ã¯ä¸å¯èƒ½ãªã®ã§ã€æ–°ãŸã«[okome](https://github.com/yukinarit/okome)ã¨ã„ã†dataclasså®šç¾©ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®docstringã‚’å–å¾—ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã‚Šã¾ã—ãŸã€‚

https://github.com/yukinarit/okome

ã“ã‚“ãªã‚¯ãƒ©ã‚¹ãŒã‚ã£ãŸå ´åˆ
```python
@dataclasses.dataclass
class Foo:
    """
    This is a comment for class `Foo`.
    """
    a: int
    """ This is valid comment for field that can be parsed by okome """
```

ã‚¯ãƒ©ã‚¹ã¨docstringã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã§ãã¾ã™ã€‚
```python
c = okome.parse(Foo)
print(f"Class comment: {c.comment}")
for f in c.fields:
    print(f'Field "{f.name}" comment: {f.comment}')
```

```
$ python simple.py
Class comment: ['This is a comment for class `Foo`.']
Field "a" comment: ['This is valid comment for field that can be parsed by okome']
Field "b" comment: ['Multi line comment', 'also works!']
```

### è§£æçµæœã‚’classã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹

`argparse.ArgumentParser`ã®è§£æçµæœã¯`vars`ãƒ“ãƒ«ãƒˆã‚¤ãƒ³é–¢æ•°ã‚’ä½¿ã†ã¨`dict`ã«å¤‰æ›ã§ãã‚‹ã®ã§ã€dictã‹ã‚‰ã‚¯ãƒ©ã‚¹ã¸ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’`pyserde`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦è¡Œã£ã¦ã„ã¾ã™ã€‚

[![](/images/3fbba1b5414b69/pyserde.png =500x)](https://github.com/yukinarit/pyserde)

## ä»Šå¾Œã«ã¤ã„ã¦

`oppapi`ã¯ã¾ã ç”Ÿã¾ã‚ŒãŸã°ã‹ã‚Šã®Toyãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã™ãŒã€é ‘å¼µã£ã¦é–‹ç™ºã¯ç¶šã‘ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚ã¨ã‚Šã‚ãˆãšã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…äºˆå®šã§ã™ã€‚
* subcommandã®å®‰å®šåŒ–
* flatten
* ã‚³ãƒãƒ³ãƒ‰ã®ãƒ˜ãƒ«ãƒ—ã®colorize
* ãã®ä»–`argparse`, `click`ã§ã§ãã‚‹æ©Ÿèƒ½ã®å®Ÿè£…

ä»Šãªã‚‰ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã—æ”¾é¡Œãªã®ã§ã€èˆˆå‘³ã‚ã‚‹æ–¹ã¯é€£çµ¡ãã ã•ã„ã€‚

[![](/images/3fbba1b5414b69/oppapi.png =500x)](https://github.com/yukinarit/oppapi)

[^1]: [2020 å¹´ç‰ˆ Command Line Tool ã‚’ä½œã£ã¦ã¿ã‚‹ in Rust](https://qiita.com/watawuwu/items/a6cbcd92dfb5336b9a01)
