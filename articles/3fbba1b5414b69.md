---
title: "oppapiã¨ã„ã†æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã£ã¦ã„ã¾ã™"
emoji: "ğŸ¤©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python"]
published: false
---

## Motivation

ç­†è€…ã¯æ™®æ®µRustã¨Pythonã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒå¤šã„ã®ã§ã™ãŒã€Rustã«ã¯[structopt](https://github.com/TeXitoi/structopt) [^1]ã¨ã„ã†ã¨ã¦ã‚‚ã¨ã¦ã‚‚ä¾¿åˆ©ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’å‹ã‚’ä½¿ã£ã¦æ°—æŒã¡ã‚ˆãæ›¸ã‘ã¾ã™ã€‚

### `structopt`

Rustã®`structopt`ã‚¯ãƒ¬ãƒ¼ãƒˆã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«structã«attributeã‚’ä»˜ã‘ã‚‹ã¨ã€structãŒã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã¨ãªã‚Šã€ å‹æƒ…å ±ã¨attributeã‹ã‚‰æ§˜ã€…ãªæ©Ÿèƒ½ã‚’æŒã£ãŸãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚Œã¾ã™ã€‚

```rust
#[derive(StructOpt, Debug)]
#[structopt(name = "basic")]
struct Opt {
    #[structopt(short, long)]
    debug: bool,

    #[structopt(short, long, parse(from_os_str))]
    output: PathBuf,

    #[structopt(short = "c", long)]
    nb_cars: Option<i32>,

    #[structopt(name = "FILE", parse(from_os_str))]
    files: Vec<PathBuf>,
}
```

### `click`

ç­†è€…ã¯ä»¥å‰ã‹ã‚‰[click](https://github.com/pallets/click)ã¨ã„ã†pythonã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ã‚ˆãä½¿ã£ã¦ã„ã¾ã—ãŸã€‚`click`ã‚’ä½¿ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ä½¿ã£ã¦å®£è¨€çš„ã«ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚Œã¦ä¾¿åˆ©ãªã®ã§ã™ãŒã€è§£æçµæœãŒå€‹åˆ¥ã«å¤‰æ•°ã«ãªã‚‹ã®ã¨ã€mypyã‚„LSPã§å‹ã‚’èªè­˜ã—ã¦ã‚‚ã‚‰ã†ã«ã¯ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã ã‘ã§ãªãå¤‰æ•°å´ã«ã‚‚å‹å®£è¨€ãŒå¿…è¦ã ã£ãŸã‚Šã§é¢å€’ã ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚

```python
@click.command()
@click.option("--count", default=1, help="Number of greetings.")
@click.option("--name", prompt="Your name", help="The person to greet.")
def hello(count, name):
    ...
```

ã¾ãŸã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¤šããªã‚‹ã¨è‡ªç„¶ã¨classã«ã¾ã¨ã‚ãŸããªã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ¥é€”dataclassã‚’ä½œã‚‹ã®ã‚‚é¢å€’ã§ã—ãŸã€‚

```python
@dataclass
class Opt:
    count: int
    name: str

@click.command()
@click.option("--count", default=1, help="Number of greetings.")
@click.option("--name", prompt="Your name", help="The person to greet.")
def hello(**kwargs):
    opt = Opt(**kwargs)
    ...
```

### `oppapi`

ä»¥ä¸Šã®ä¸æº€ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«`oppapi` (ãŠã£ã±ã£ã´ãƒ¼)ã¨ã„ã†æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚Šå§‹ã‚ã¾ã—ãŸã€‚`oppapi`ã¯[dataclasses](https://docs.python.org/3/library/dataclasses.html)ã¨[argparse](https://docs.python.org/3/library/argparse.html)ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ãŠã‚Šã€`structopt`ã®ã‚ˆã†ã«å‹ã‚’åˆ©ç”¨ã—ã¦æ°—æŒã¡ã‚ˆãCLIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ›¸ã‘ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚

## Usage

```python
from typing import Optional
from oppapi import from_args, oppapi

@oppapi
class Opt:
    """
    Option parser using oppapi
    """

    host: str
    """ Primitive type will be positional argument """

    port: Optional[int] = 8000
    """ Optional type will be option argument """

opt = from_args(Opt)
print(opt)
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`Opt`ã‚¯ãƒ©ã‚¹ã®å‹å®£è¨€ã«åŸºã¥ã„ã¦ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒ¼ã‚µãƒ¼ã«ã¯ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚
* ã‚¯ãƒ©ã‚¹ã®docstringã‹ã‚‰ãƒ‘ãƒ¼ã‚µãƒ¼ã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆã™ã‚‹
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®docstringã‹ã‚‰å¼•æ•°ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆã™ã‚‹
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¼•æ•°ã«ãªã‚‹
* `Optional`ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã«ãªã‚‹

```
$ python simple.py -h
usage: simple.py [-h] [-p PORT] host

Option parser using oppapi

positional arguments:
  host                  Primitive type will be positional argument

optional arguments:
  -h, --help            show this help message and exit
  -p PORT, --port PORT  Optional type will be option argument
  ```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å¼•æ•°ã‚’ä¸ãˆã‚‹ã¨ã€`Opt`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãªã‚Šã¾ã™ã€‚

```
$ python simple.py 127.0.0.1 -p 80
Opt(host='127.0.0.1', port=80)
```

## Features


### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®shortã¨longã®è¨­å®š

### `short`/`long`åã®å¤‰æ›´

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ•ãƒ©ã‚°åãŒç”Ÿæˆã•ã‚Œã¾ã™ãŒã€`short`, `long`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã‚’ä»˜ã‘ã‚Œã°ã€ä»»æ„ã®`short`/`long`åã«å¤‰æ›´ã§ãã¾ã™ã€‚

```python
from typing import Optional
from oppapi import from_args, oppapi, field

@oppapi
class Opt:
    host: Optional[str] = field(short="-n", long="--hostname")
```

### `enum`

`enum.Enum`ã€`enum.IntEnum`ã‚’è¨­å®šã™ã‚‹ã¨ã€è‡ªå‹•ã§`choices`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ãã‚Œã¾ã™ã€‚

```python
class Food(Enum):
    A = "Apple"
    B = "Beer"
    C = "Chocolate"

class Price(IntEnum):
    A = 10
    B = 20
    C = 30

@oppapi
class Opt:
    food: Food
    price: Optional[Price]
```

usageã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã€
```
positional arguments:
  {Apple,Beer,Chocolate}

optional arguments:
  -h, --help            show this help message and exit
  -p {10,20,30}, --price {10,20,30}
```

ã‚³ãƒãƒ³ãƒ‰å¼•æ•°è§£æã™ã‚‹ã¨ã¡ã‚ƒã‚“ã¨Enumå‹ã«æˆ»ã—ã¦ãã‚Œã¾ã™ã€‚

```python
$ python choice.py Apple --price 20
Opt(food=<Food.A: 'Apple'>, price=<Price.B: 20>)
```

### `nargs`

`List`ã¯ä»»æ„é•·ã®å¼•æ•°(`nargs="+"`)ã«ãªã‚Šã€`Tuple`ã¯å›ºå®šé•·ã®å¼•æ•°(`nargs=NUM`)ã«ãªã‚Šã¾ã™ã€‚
```python
@oppapi
class Opt:
    values: List[int]
    opts: Optional[Tuple[int, str, float, bool]]
```

### `datetime`
### `ipaddress`
### `pathlib`
### `decimal`
### `uuid`

## How does it work

ã–ã£ãã‚Šã“ã‚“ãªæµã‚Œã«ãªã‚Šã¾ã™ã€‚

```mermaid
graph TB
    A[okomeã§dataclasså®šç¾©ã‹ã‚‰docstringã‚’å–å¾—ã™ã‚‹] --> B[dataclasså®šç¾©ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹]
    B --> C[docstringã¨å‹æƒ…å ±ã‹ã‚‰argparse.Parserã‚’ä½œã‚‹]
    C --> D[parserã‚’èµ·å‹•ã—ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³è§£æã‚’ã™ã‚‹]
    D --> E[è§£æçµæœã‚’pyserdeã§classã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹]
```

å„å·¥ç¨‹ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

### `okome`ã§dataclasså®šç¾©ã‹ã‚‰docstringã‚’å–å¾—ã™ã‚‹

`structopt`ã®æ¬ ã‹ã›ãªã„æ©Ÿèƒ½ã¨ã—ã¦ã€structã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®ãƒ˜ãƒ«ãƒ—ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚dataclassesã§æä¾›ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã®ã¯ä¸å¯èƒ½ãªã®ã§ã€æ–°ãŸã«
[okome](https://github.com/yukinarit/okome)ã¨ã„ã†dataclasså®šç¾©ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®docstringã‚’å–å¾—ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã‚Šã¾ã—ãŸã€‚

ã“ã‚“ãªã‚¯ãƒ©ã‚¹ãŒã‚ã£ãŸå ´åˆ
```python
@dataclasses.dataclass
class Foo:
    """
    This is a comment for class `Foo`.
    """

    a: int
    """ This is valid comment for field that can be parsed by okome """
    b: str
    """
    Multi line comment
    also works!
    """
```

ã‚¯ãƒ©ã‚¹ã¨docstringã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã§ãã¾ã™ã€‚
```python
c = okome.parse(Foo)
print(f"Class comment: {c.comment}")
for f in c.fields:
    print(f'Field "{f.name}" comment: {f.comment}')
```

```
$ python simple.py
Class comment: ['This is a comment for class `Foo`.']
Field "a" comment: ['This is valid comment for field that can be parsed by okome']
Field "b" comment: ['Multi line comment', 'also works!']
```

### dataclasså®šç¾©ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹

`dataclasses`ã®[field](https://docs.python.org/3/library/dataclasses.html#dataclasses.field)é–¢æ•°ã‚’ä½¿ãˆã°ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ•°åã‚„å‹æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

### docstringã¨å‹æƒ…å ±ã‹ã‚‰argparse.Parserã‚’ä½œã‚‹

### parserã‚’èµ·å‹•ã—ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³è§£æã‚’ã™ã‚‹

### `pyserde`ã§classã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹

### è§£æçµæœã‚’pyserdeã§classã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹


## ä»Šå¾Œã®

[^1]: [Rustã‚¨ãƒ©ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒˆãƒ¬ãƒ³ãƒ‰è§£èª¬ï¼ˆ2020å¹´1æœˆç‰ˆï¼‰](https://qiita.com/dalance/items/7e0fa481626c76d59f65)
