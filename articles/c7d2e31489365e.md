---
title: "OCPIプロトコルとは？"
emoji: "⚡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ocpi"]
published: false
publication_name: mapbox_japan
---

OCPIプロトコルとはOpen Charge Point Interfaceの略で電気自動車(以下EVと略す)の充電インフラとのやり取りを定義した仕様です。仕様書はGithubにホストされているので誰でも読め、間違い等があったりしたらPRを送ることができます。

https://github.com/ocpi/ocpi

:::message
2023年11月2日時点で最新のOCPI v2.2.1の仕様について解説します
:::

## OCPIが生まれた背景

EV充電施設が世界中に急速に広まっています。米国でセブンイレブンが[7Charge](https://www.7-eleven.com/7charge)という充電施設を運営しています。今後も様々な企業が参入し、EV充電施設を提供していくでしょう。これらEV充電施設事業者が独自のネットワークを構成して、ユーザー向けのサービスを提供していますが、これらサービスを横断してアクセスする手段がないとユーザーにとっての利便性は低いといえるでしょう。またEVメーカーや国ごとにコネクタ仕様等も異なることもガソリン車とは違いユーザーの負担になります。

OCPIはこれらの課題を解決するべく、充電インフラとユーザー間のやり取りを標準化するために作られました。

## 概要

OCPIはCPOとeMSPのやり取りを定義した仕様です。CPO (Charging Point Operator)とはEV充電施設事業者であり、EVの充電インフラを管理・運営する組織を意味します。eMSP (e-Mobility Service Provider)はeモビリティサービス事業者を意味し、複数のCPOを集約し、ユーザーに充電に関する様々な付加価値を提供する組織を意味します。

携帯電話回線で例えるとCPOはNTTドコモ、Softbank、KDDIやのような携帯キャリアで、全国に携帯電話回線を整備します。eMSPはMVNOのような企業で携帯キャリアの回線を借りてユーザーにサービスを提供します。eMSPが複数のCPOに接続するのは、MVNOのIIJmioでユーザーがDocomoかauの回線を選ぶことができることに似ています。また、CPOは必ずしもインフラだけを提供するわけではなくeMSPを兼ねている場合もあります。これも携帯電話回線で例えると、Softbankが携帯キャリアとして自身の料金プランを提供している感じです。

![](/images/c7d2e31489365e/emsp-topology.png =300x)
*出典: https://github.com/ocpi/ocpi/blob/master/topology.asciidoc*

OCPIにはHubという概念もあり、Hubは複数のeMSPとCPOを仲介します。携帯電話回線で例えると、HubはNTTドコモとソフトバンクをつなぐ交換局や、海外のキャリアとつなぐ国際ローミングと捉えていいでしょう。

![](/images/c7d2e31489365e/hub-topology.png =300x)
*出典: https://github.com/ocpi/ocpi/blob/master/topology.asciidoc*

また、OCPIの説明からは脱線しますが、eMSPとHubはOCPI以外の標準プロトコルやプロプライエタリなプロトコルでサービス提供するCPOとのプロトコル変換をすることもあります。

## 通信仕様

OCPIはデータモデル以外にも通信仕様を含みます。OCPIの通信仕様は標準的なHTTP/JSONを使います。つまりRESTfulなWebAPIなのでWeb開発者には馴染みやすいかと思います。

### モジュールとは？

モジュールとはOCPIのオブジェクト及びI/Fの役割別の仕様です。OCPI 2.2では以下のモジュールがあります。

* CDRs: 充電セッションのインボイス的な情報
* Charging Profiles: EVSEの充電プロファイル(duration, 充電速度等)
* Commands: ユーザーからCPOに送られるイベント(開始、終了、予約等)
* Credentials: CPOやeMSPのサービス同士のcredentialsの交換(ハンドシェイク)
* HubInfo: Hubへの接続状況等
* Locations: 充電施設(EVSE, Connector等)の情報
* Sessions: 充電セッション
* Tariffs: 電気料金(タリフ)
* Tokens: 充電施設とユーザーとの認証トークン(RFID, Mobileアプリトークン等)
* Versions: OCPIのサポート状況

### SenderとReceiver

OCPIにはモジュール毎にSenderとReceiverのI/Fが定義されています。常にCPOがSenderでeMSPがReceiverになるわけではなく、eMSPがSenderでCPOがReceiverになることもあるので、どちらがSender/Receiverになるかしっかりと認識して仕様書を読みましょう。

以下のテーブルはモジュール別にCPO, eMSP, HubがSender/Receiverになり得るかをまとめています。基本的な捉え方として、どちらがデータのオーナーかを考えます。例えば、充電施設を管理運営しているのはCPOで、eMSPは充電施設を持っていませんのでLocationsモジュールではSenderがCPO、ReceiverがeMSPとされています。一方、Commandsモジュールではユーザーの充電に関するイベントをCPOに通知する仕組みなので、SenderがeMSP、ReceiverがCPOとなります。

:::message
あくまで想定されている典型的なコミュニケーション例として解説の際にSenderとReceiverと想定しています。OCPI自体は汎用的なプロトコルで、どちらがSender, Receiverにならなければいけないとは定義していませんので、それ以外の使い方をしたらSender, Redeiverが逆転することも考えられます。
:::

| Modules           | CPO      | eMSP      | Hub    |
|-------------------|----------|-----------|--------|
| CDRs              | Sender   | Receiver  | Both   |
| Charging Profiles | Receiver |           | Both   |
| Commands          | Receiver | Sender    | Both   |
| Credentials       | Both     | Both      | Both   |
| HubInfo           | Receiver | Receiver  | Sender |
| Locations         | Sender   | Receiver  | Both   |
| Sessions          | Sender   | Receiver  | Both   |
| Tariffs           | Sender   | Receiver  | Both   |
| Tokens            | Receiver | Sender    | Both   |
| Versions          | Both     | Both      | Both   |

### PushとPull

OCPIはモジュールによってはPushとPull型があります。Push型はSender側からHTTP/POSTやHTTP/PUT, HTTP/PATCH等でReceiverにデータを送信することを意味します。Pull型はReceiver側がSenderに対してHTTP/GETでリクエストを送りデータを取得することを意味します。OCPIではモジュールによりますが、PushとPullの両方をサポートする場合もあり、どちらを使うかは実装者が選択可能です。ただし、後述するDynamicデータの取得に関しては、Pull型を使用するとポーリングになるのでOCPIとしてはPush型を使うことが推奨されています。

### Static/Dynamicデータ

OCPIにはStatic/Dynamicデータという定義は存在しませんが、StaticとDynamicデータに分けて考えると理解の助けになるので解説します。

:::message
eMSPでの目線における解説になります。
:::

StaticデータとはeMSPがCPOからバルクで取得する各モジュールの全データのスナップショットになります。eMSPはCPOが所有しているデータと同期を取るためにStaticデータを取得します。データ量が多いのでしばしば数日や一週間に一回の頻度で行われます。eMSPはCPOのGETインターフェイスを使ってStaticデータを取得しますが、一度に全件返すことはできないので、何回もpagenateされたリクエストを送ることになります。

![](/images/c7d2e31489365e/static.png)

DynamicデータはCPOから送られる各モジュールの更新情報となります。例えば、EVSEやコネクタの利用状況(Availability)やEVSEの新規追加・変更・削除があります。DynamicデータはeMSPからpullモードで都度取得する方法とCPOからpushモードで受け取る２つの方法があります。pullモードの場合は、リクエストのURLに`date_from`と`date_to`クエリパラメータを指定し、CPOはfrom/toの間に変更されたオブジェクトを返します。pushモードではCPOが変更されたオブジェクトだけをeMSPに送信します。pullモードだとポーリングになってしまい、即時性がないのでpushモードを使うことが推奨されています。

![](/images/c7d2e31489365e/dynamic-pull.png)

![](/images/c7d2e31489365e/dynamic-push.png)

## Credentials and Versions

TODO

## Locatios

TODO

Locationは1つの充電ステーションを表す。Locationは複数のEVSEを持ち(1:n)、各EVSEは複数のコネクタを持つことができる。CPOがLocationオブジェクトを作ると、eMSPにPUTメソッドで送信する。CPOがLocationオブジェクトを置き換えたいときは再度eMSPにPUTリクエストを送ることができる。Locationオブジェクトに対する変更はPATCHメソッドでeMSPに送られる。

## Sessions

TODO

## Tariffs

TODO

## CDRs

TODO

CDR (Change Detail Record)とはすでに完了した充電セッションの詳細です。CDRはセッション終了後にCPOからeMSPに送信されます。セッションオブジェクトとの違いは、セッションは現時点の充電セッションの動的な情報で、ドライバーが見るためのものです。CDRは逆にドライバーから見えない形で作られ、充電セッション開始時のLocationやTariff情報などを含みます。

## Token

TODO

Tokenはドライバーに充電を認可するための情報で、eMSPからCPOへ送られます。APIのTokenヘッダとは別物なので注意してください。

## OCPI 3

TODO
