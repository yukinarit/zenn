---
title: "mapbox-gl-jsä¸Šã§Parrotã‚’Partyã•ã›ã‚‹æ–¹æ³•3é¸"
emoji: "ğŸ¦œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["JavaScript", "mapbox"]
published: true
---

::::message
ã“ã®è¨˜äº‹ã¯[Mapbox Advent Calendar 2022](https://qiita.com/advent-calendar/2022/mapbox)ã®25æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
::::

[mapbox-gl-js](https://github.com/mapbox/mapbox-gl-js)ã¯ç´ æ™´ã‚‰ã—ã„åœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ãŒã€æ®‹å¿µãªãŒã‚‰Party Parrotã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚ æœ¬è¨˜äº‹ã§ã¯ãƒãƒƒãƒˆä¸Šã§è‰²ã€…æ¤œç´¢ã—ã¦è¦‹ã¤ã‘ãŸParrotã‚’Partyã•ã›ã‚‹æ–¹æ³•ã‚’3ã¤ç´¹ä»‹ã—ã¾ã™ã€‚

### NGä¾‹: GIFã‚’ãã®ã¾ã¾æç”»ã™ã‚‹

ã“ã®ã‚ˆã†ã«`loadImage`é–¢æ•°ã§GIFãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¸¡ã—ã¦ã‚„ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ã¯èµ·ã“ã‚‰ãªã„ã§ã™ãŒã€ParrotãŒPartyã—ã¦ãã‚Œã¾ã›ã‚“ ğŸ˜¢ ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://gist.github.com/yukinarit/7b4e43fe5a9df0cf33cfc31e0969a6b5)

```js
  map.on('load', () => {
    map.loadImage('partyparrot.gif',
      (e, image) => {
        map.addImage('parrot', image);
        map.addSource('point', {
          'type': 'geojson',
          'data': {
          'type': 'FeatureCollection',
          'features': [{
            'type': 'Feature',
            'geometry': {
            'type': 'Point',
            'coordinates': [139.763906, 35.6811649]
          }}]
        }});
        map.addLayer({ 'id': 'points', 'type': 'symbol', 'source': 'point', 'layout': { 'icon-image': 'parrot', 'icon-size': 0.25 } });
    });
  });
```

![](/images/0881bfe98b17d9/parrot-gif.gif)

### 1. å‹•ç”»ã«ã™ã‚‹

GIFãƒ•ã‚¡ã‚¤ãƒ«ã‚’[ezgif.com](https://ezgif.com/gif-to-webm)ã§webmå½¢å¼ã«å¤‰æ›ã—ã¦mapgox-gl-jsã«videoã‚¢ã‚»ãƒƒãƒˆã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¾ã—ãŸã€‚mp4ã ã¨èƒŒæ™¯ã‚’é€éã«ã§ããªã„ã®ã§webmå½¢å¼ã«ã—ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://gist.github.com/yukinarit/4fb808ae0cf226ebc3a8ff20bdd28d19)ã€‚

* ãƒ¡ãƒªãƒƒãƒˆ
    * ã‚³ãƒ¼ãƒ‰çš„ã«ã¯ç°¡å˜ï¼Ÿ
* ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
    * GIFã‚’webmå½¢å¼ã«å¤‰æ›ã™ã‚‹ã®ãŒé¢å€’
    * ãƒ“ãƒ‡ã‚ªãƒªã‚½ãƒ¼ã‚¹ã®çŸ©å½¢åº§æ¨™(coordinates)ã‚’æ­£ç¢ºã«çŸ¥ã‚‹ã®ãŒé›£ã—ã„ã€‚ã¡ã‚‡ã£ã¨ç¸¦é•·ã«ãªã£ã¦ã‚‹ï¼Ÿw
    * ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã™ã‚‹ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚µã‚¤ã‚ºãŒã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ï¼Ÿ

```js
  map.on('load', () => {
    map.addSource('video', {
      'type': 'video',
      'urls': [
        'partyparrot.webm',
      ],
      'coordinates': [
        [139.763906, 35.6811649],
        [139.764906, 35.6811649],
        [139.764906, 35.6801649],
        [139.763906, 35.6801649],
      ]
    });
    map.addLayer({
      'id': 'video',
      'type': 'raster',
      'source': 'video'
    });
  });
```

![](/images/0881bfe98b17d9/parrot-video.gif)

### 2. `background-image`ã‚’ä½¿ã†

[StackOverflowã§è¦‹ã¤ã‘ãŸæ–¹æ³•](https://stackoverflow.com/a/53492711)ã§ã€CSSã®`backgroup-image`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å·®ã—è¾¼ã‚“ã§ã‚„ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://gist.github.com/yukinarit/8ea3deebb4210267285fb829eebbf112)ã€‚

* ãƒ¡ãƒªãƒƒãƒˆ
    * GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºãŒæŒ‡å®šã—ãŸãƒ”ã‚¯ã‚»ãƒ«ã§å›ºå®šã•ã‚Œã‚‹
    * ã‚³ãƒ¼ãƒ‰çš„ã«ã¯ä¸€ç•ªã‚·ãƒ³ãƒ—ãƒ«ï¼Ÿ
* ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
    * Parrotã‚’è¿½åŠ ã™ã‚‹ãŸã³ã«divãŒå¢—ãˆã¦ã„ã

```javascript
  map.on('load', () => {
    var el = document.createElement('div');
    el.className = 'marker';
    el.setAttribute('style', 'background-image: url(partyparrot.gif); width: 32px; height: 32px; background-size: 32px 32px;');

    new mapboxgl.Marker(el)
      .setLngLat([139.763906, 35.6811649])
      .addTo(map);
  });
```

![](/images/0881bfe98b17d9/parrot-div.gif)

### 3. Canvasã‚’ä½¿ã†

mapbox-gl-jsã¯Canvasãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚‹ã®ã§ã€[gifler](https://themadcreator.github.io/gifler/)ã¨ã„ã†GIFã‚’Canvasã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã¦ã‚„ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://gist.github.com/yukinarit/13c1e6992ba6089ee32857a3c3e9fbfd)ã€‚

* ãƒ¡ãƒªãƒƒãƒˆ
    * ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ã«åœæ­¢ãƒ»å†é–‹ã—ãŸã‚Šå†ç”Ÿé€Ÿåº¦ã‚’èª¿ç¯€ã§ãã‚‹
* ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
    * ã‚³ãƒ¼ãƒ‰çš„é‡ãŒå¤šã„
    * å°‘ã—è² è·ãŒå¤§ããã†

```javascript
  const size = 128;

  const parrot = {
    width: size,
    height: size,
    data: new Uint8Array(size * size * 4),
    onAdd: function () {
      const canvas = document.createElement('canvas');
      canvas.width = this.width;
      canvas.height = this.height;
      this.context = canvas.getContext('2d');
      this.parrot = gifler('partyparrot.gif');
      this.parrot.animate(canvas);
    },
    render: function () {
      this.data = this.context.getImageData(0, 0, this.width, this.height).data;
      map.triggerRepaint();
      return true;
    }
  };

  map.on('load', () => {
    map.addImage('parrot', parrot, { pixelRatio: 2 });
    map.addSource('parrot-point', {
      'type': 'geojson',
      'data': {
        'type': 'FeatureCollection',
        'features': [
          {
            'type': 'Feature',
            'geometry': {
            'type': 'Point',
            'coordinates': [139.763906, 35.6811649]
            }
          }
        ]
      }
    });
    map.addLayer({
      'id': 'layer-with-parrot',
      'type': 'symbol',
      'source': 'parrot-point',
      'layout': {
      'icon-image': 'parrot'
    }
  });
```

![](/images/0881bfe98b17d9/parrot-canvas.gif)

### ã¾ã¨ã‚

mapbox-gl-jsä¸Šã§PartyParrotã‚’å‹•ã‹ã™æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚3ã¤ã®æ–¹æ³•ã¯ä¸€é•·ä¸€çŸ­ãŒã‚ã‚Šã¾ã™ãŒã€å€‹äººçš„ã«ã¯ä»¥ä¸‹ã®çµè«–ã§ã™ã€‚
* æ™®é€šã«GIFã‚’è¡¨ç¤ºã—ãŸã„ã ã‘ãªã‚‰2.background-imageã‚’ä½¿ã†
* ãƒªãƒƒãƒã«å‹•ã‹ã—ãŸã„å ´åˆã¯3. Canvasã‚’ä½¿ã†

ã“ã®ä»–ã«ã„ã„æ–¹æ³•ã‚’çŸ¥ã£ã¦ã„ã‚‹äººãŒã‚ã£ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
