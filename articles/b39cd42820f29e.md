---
title: "Rust/Anyhowã®Tips"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rust"]
published: false
---

Ruståˆå­¦è€…ãŒè‹¦æˆ¦ã™ã‚‹ã®ã“ã¨ã®ä¸€ã¤ã«ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã‚‚ãã†ã§ã—ãŸã€‚ä¾‹å¤–ã®ã‚ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª(C++, C#, Java)ã‹ã‚‰æ¥ã‚‹ã¨ã€Rustã®Resultã€Optionã¯ã¨ã£ã¤ãã«ãã•æ„Ÿã˜ã¾ã™ãŒã€ä½¿ã„ã“ãªã›ã°è¶…å¼·åŠ›ãªæ­¦å™¨ã«ãªã‚Šã¾ã™ã€‚

[anyhow](https://github.com/dtolnay/anyhow)ã¯2019é ƒã«å‡ºã¦ããŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ç­†è€…ã®è¦³æ¸¬ç¯„å›²[^1]ã§ã¯2021å¹´10æœˆæ™‚ç‚¹ã«ãŠã‘ã‚‹ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¨ãƒ©ãƒ¼ç®¡ç†crateã¨è¨€ã£ã¦è‰¯ã„ã¨æ€ã†ã€‚ã¡ãªã¿ã«anyhowã®ä½œè€…David Tolnayæ°ã¯Rustç•Œã§ã¯è‘—åãªé–‹ç™ºè€…ã§ã€[serde-rs](https://github.com/serde-rs)ãŒã‚ˆãçŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€anyhowã‚’ä½¿ã„ã“ãªã™ãŸã‚ã®Tipsã‚’ç´¹ä»‹ã—ã¦ã¿ã¾ã™ã€‚

## ãªãœanyhowã‚’ä½¿ã†ã®ã‹

ãªãœanyhowã‚’ä½¿ã†ã¹ããªã®ã‹ã¯ä»–ã®è¨˜äº‹[^2][^3]ã«ã‚ˆãã¾ã¨ã¾ã£ã¦ã„ã‚‹ã®ã§ã“ã“ã§ã¯è©³ç´°ã«æ›¸ãã¾ã›ã‚“ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªç†ç”±ãŒã‚ã‚Šã¾ã™ã€‚
* ä»–ã®ã‚¨ãƒ©ãƒ¼å‹ã‹ã‚‰`anyhow::Error`ã¸ã®å¤‰æ›ãŒå®¹æ˜“
* ã‚¨ãƒ©ãƒ¼ã®éšå±¤åŒ–
* Backtrace
* `anyhow!`, `ensure!`, `bail!`, `ensure!`ç­‰ã®ä¾¿åˆ©ãƒã‚¯ãƒ­

## `anyhow::Result`

ã“ã®ã‚ˆã†ãªtypeã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
```rust
pub type Result<T, E = Error> = core::result::Result<T, E>;
```

Resultã«äºŒã¤å‹ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã‚Š
```rust
fn foo() -> Result<(), anyhow::Error> {
    ...
}
```

ã“ã®ã‚ˆã†ã«`anyhow::Result`ã‚’ä½¿ã£ãŸã»ã†ãŒã‚¹ãƒƒã‚­ãƒªæ›¸ã‘ã¾ã™ã­ã€‚
```rust
use anyhow::Result;

fn foo() -> Result<()> {
    ...
}
```

## mainé–¢æ•°ã®æˆ»ã‚Šã«`anyhow::Result`ã‚’ä½¿ã†

mainé–¢æ•°ã®æˆ»ã‚Šå€¤ã¯[std::process::Termination](https://doc.rust-lang.org/std/process/trait.Termination.html)ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ–ãƒ©ãƒ³ã‚±ãƒƒãƒˆå®Ÿè£…ãŒã‚ã‚‹ã®ã§`anyhow::Result`ã‚’è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
impl<E: Debug> Termination for Result<(), E>
```

ã¤ã¾ã‚Š

```rust
fn main() -> anyhow::Result<()> {
    Ok(())
}
```

asyncã‚‚OK
```rust
#[tokio::main]
async fn main() -> anyhow::Result<()> {
    Ok(())
}
```

## Backtrace

Backtraceã‚’è¡¨ç¤ºã•ã›ã‚‹ã«ã¯ã€nightlyãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã‚’ä½¿ã†ã‹stableã§ä»¥ä¸‹ã®ã‚ˆã†ã«featureã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```toml
anyhow = { version = "1", features = ["backtrace"] }
```

ã¾ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã¯ç’°å¢ƒå¤‰æ•°`RUST_BACKTRACE=1`ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## `{}`ã¨`{:?}`ã®é•ã„

`anyhow::Error`ã‚’`{}`ã¨`{:?}`ã§æ–‡å­—åˆ—å‡ºåŠ›ã—ãŸã¨ãã®çµæœãŒç•°ãªã‚Šã¾ã™ã€‚

* `{}`ã®å ´åˆ

ã‚¨ãƒ©ãƒ¼ã®æ–‡å­—åˆ—ã®ã¿ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã¨`foo error`ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```rust
use anyhow::{Context, Result};

fn foo() -> Result<()> {
    bar().context("foo error")?;
    Ok(())
}

fn bar() -> Result<()> {
    baz().context("bar error")?;
    Ok(())
}

fn baz() -> Result<()> {
    Err(anyhow::anyhow!("baz error"))
}

fn main() {
    if let Err(e) = foo() {
        println!("{}", e);
    }
}
```

* `{:?}`ã®å ´åˆ

ã‚¨ãƒ©ãƒ¼ã®æ–‡å­—åˆ—ã€ã‚¹ã‚¿ãƒƒã‚¯ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã®æ–‡å­—åˆ—ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ä¸Šè¨˜ã®ä¾‹ã§`{}`ã®ä»£ã‚ã‚Šã«`{:?}`ã‚’ä½¿ã†ã¨ä»¥ä¸‹ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```rust
foo error

Caused by:
    0: bar error
    1: baz error
```
ã¾ãŸã€å‰è¿°ã—ãŸbacktraceæ©Ÿèƒ½ãŒä½¿ãˆã‚‹çŠ¶æ…‹ã«ãªã£ã¦ãŠã‚Šã€`RUST_BACKTRACE=1`ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼æƒ…å ±ã«ãƒ—ãƒ©ã‚¹ã—ã¦backtraceãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
foo error

Caused by:
    0: bar error
    1: baz error

Stack backtrace:
   0: std::backtrace_rs::backtrace::libunwind::trace
             at /rustc/1f5bc176b0e54a8e464704adcd7e571700207fe9/library/std/src/../../backtrace/src/backtrace/libunwind.rs:90:5
      std::backtrace_rs::backtrace::trace_unsynchronized
             at /rustc/1f5bc176b0e54a8e464704adcd7e571700207fe9/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5
      std::backtrace::Backtrace::create
             at /rustc/1f5bc176b0e54a8e464704adcd7e571700207fe9/library/std/src/backtrace.rs:316:13
   1: anyhow::error::<impl anyhow::Error>::msg
             at /Users/yukinari/.cargo/registry/src/github.com-1ecc6299db9ec823/anyhow-1.0.45/src/error.rs:79:36
   2: anyy::baz
             at ./src/main.rs:14:9
   3: anyy::bar
             at ./src/main.rs:9:5
   4: anyy::foo
             at ./src/main.rs:4:5
   5: anyy::main
             at ./src/main.rs:18:21
   ...
```

## `.context`ã‚’ä½¿ã†

anyhowã«ã¯`Context`ã¨ã„ã†ãƒˆãƒ¬ã‚¤ãƒˆãŒã‚ã‚Šã€`std::error::Error`ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼å‹ã«æ–°ãŸã«ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ ã—ã¤ã¤`anyhow::Error`ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
use anyhow::{Context, Result};

fn foo() -> Result<()> {
    std::fs::open("config.yml").context("Failed to open config file")?;

    ...
}
```

## `.with_context`ã‚’ä½¿ã†

ä»¥ä¸‹ã®ã‚ˆã†ãª`format!`ã—ã¦ã‚¨ãƒ©ãƒ¼æ–‡ã‚’ä½œã£ãŸã‚Šã™ã‚‹å ´åˆã ã¨`.context`ã ã¨ã‚¨ãƒ©ãƒ¼ã˜ã‚ƒãªãã¦ã‚‚æ¯å›`format!`ãŒå‘¼ã°ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚`with_context`ã‚’ä½¿ãˆã°ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’æ¸¡ã›ã‚‹ã®ã§`format!`ã¯ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```rust
use anyhow::{Context, Result};

fn foo() -> Result<()> {
    let path = "config.yml";
    std::fs::open(path).context(|| format!("Failed to open config file: {}", path))?;

    ...
}
```

## `use anyhow::Context as _`ã§åå‰ç©ºé–“æ±šæŸ“ã‚’é˜²ã

æ¯”è¼ƒçš„æ–°ã—ã„[Underscore Import](https://doc.rust-lang.org/reference/items/use-declarations.html#underscore-imports)ã¨ã„ã†æ©Ÿèƒ½ã«ã‚ˆã£ã¦

```rust
use anyhow::Context as AnyhowContext;
```
ã®ã‚ˆã†ã«ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä»˜ã‘ã¦ã„ãŸã®ãŒã€`_`ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```rust
use anyhow::Context as _;
```

è©³ã—ãã¯[anyhow::Context ã‚’ use ã—ãŸã„ãŒåå‰ãŒè¢«ã£ã¦ã—ã¾ã†ã¨ãã®è§£æ±ºç­– -> impl-only-use](https://zenn.dev/magurotuna/articles/2c4037b75f7e51)ã‚’å‚ç…§ã€‚

## `anyhow!`ã‚’ä½¿ã†

`anyhow!`ãƒã‚¯ãƒ­ã‚’ä½¿ãˆã°ç°¡å˜ã«`anyhow::Error`ã‚’ä½œã‚Œã¾ã™ã€‚

1. ã‚¨ãƒ©ãƒ¼å‹ã‚’æ¸¡ã™

```rust
use anyhow::{Result, anyhow};

fn foo() -> Result<()> {
    std::fs::File::open("a.yml").map_err(|e| anyhow!(e))?;
    ...
}
```

2. æ–‡å­—åˆ—ã‚’æ¸¡ã™

```rust
use anyhow::{Result, anyhow};

fn validate(s: &str) -> Result<()> {
    if s.len() >= 10 {
        return Err(anyhow!("Length must be less than 10"));
    }
    ...
}
```

3. `format!`ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ã†

```rust
use anyhow::{Result, anyhow};

fn validate(s: &str) -> Result<()> {
    if s.len() >= 10 {
        return Err(anyhow!("Length of string \"{}\" must be less than 10", s));
    }
    ...
}
```

ç­†è€…ã®çµŒé¨“ä¸Šã§ã¯2ã‹3ã‚’ä½¿ã†å ´åˆãŒã»ã¨ã‚“ã©ã§ã—ãŸã€‚1ã®å ´åˆã¯ãƒã‚¯ãƒ­ã‚’ä½¿ã†ä»£ã‚ã‚Šã«`anyhow::Error::from`ã‚„`.context`ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸã€‚

## `bail!`ã‚’ä½¿ã†

ä¸Šè¨˜ã®2, 3ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã¯`bail!`ã‚’ä½¿ã†ã¨ã‚‚ã£ã¨ç°¡å˜ã«æ›¸ã‘ã¾ã™ã€‚

```rust
use anyhow::{Result, bail};

fn validate(s: &str) -> Result<()> {
    if s.len() >= 10 {
        bail!("Length of string \"{}\" must be less than 10", s);
    }
    ...
}
```

ã¤ã¾ã‚Š`bail!`ã¯`return Err(anyhow!(...))`ã®ç°¡ç•¥åŒ–ã—ãŸæ›¸ãæ–¹ã§ã™ã€‚

## `ensure!`ã‚’ä½¿ã†

ä¸Šè¨˜ã®ä¾‹ã¯`ensure!`ã‚’ä½¿ã†ã¨ã•ã‚‰ã«çŸ­ãæ›¸ã‘ã¾ã™ã€‚

```rust
use anyhow::{Result, ensure};

fn validate(s: &str) -> Result<()> {
    ensure!(s.len() >= 10, "Length of string \"{}\" must be less than 10", s);
    ...
}
```

[^1]: [Rustã‚¨ãƒ©ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒˆãƒ¬ãƒ³ãƒ‰è§£èª¬ï¼ˆ2020å¹´1æœˆç‰ˆï¼‰](https://qiita.com/dalance/items/7e0fa481626c76d59f65)
[^2]: [Rust ã‚¨ãƒ©ãƒ¼å‡¦ç†2020 - é›»æ°—ã²ã¤ã˜ç‰§å ´](https://cha-shu00.hatenablog.com/entry/2020/12/08/060000)
[^3]: [rust ã®ã‚¨ãƒ©ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ failure ã‚’ä½¿ã‚ãªã„ã§ãã ã•ã„](https://qiita.com/legokichi/items/d76b6aa5dac2ad781bda#ã‚¨ãƒ©ãƒ¼é–“ã®å¤‰æ›ã‚’æ›¸ã)
