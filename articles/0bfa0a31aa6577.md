---
title: "k8sä¸Šã§Rustã§ä½œã£ãŸgRPCã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹"
emoji: "ğŸ±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rust", "Kubernetes", "gRPC", "Grafana"]
published: false
---

## ã¯ã˜ã‚ã«

å®Ÿç”¨çš„ãªã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºã€é‹ç”¨ã™ã‚‹ä¸Šã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆæ¸¬ãƒ»å¯è¦–åŒ–ã¯å¿…è¦ä¸å¯æ¬ ãªã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚Rustè¨€èªã§ãã®ã‚ˆã†ãªè¨˜äº‹ã‚„å…·ä½“çš„ãªã‚µãƒ³ãƒ—ãƒ«ãŒãªã‹ã£ãŸã®ã§ã€ã‚„ã‚Šæ–¹ã‚’è§£èª¬ã—ã¦ã¿ã¾ã™ã€‚

## ã‚„ã‚ŠãŸã„ã“ã¨

![](/images/0bfa0a31aa6577/overview.png)

* Rustã§è¶…ã‚·ãƒ³ãƒ—ãƒ«ãªgRPCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹
* [metrics-rs](https://github.com/metrics-rs/metrics)ã‚’ä½¿ã£ã¦gRPCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²ã™ã‚‹
* ä½œã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Kubernetesä¸Šã§å‹•ã‹ã™
* Prometheusã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’Service Discoveryã—ã¦Grafanaã§å¯è¦–åŒ–ã™ã‚‹

## Rustã§gRPCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹

Rustã§gRPCã‚’ä½¿ã†é¸æŠè‚¢ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™[^1]ã€‚ä»Šå›ã¯[tonic](https://github.com/hyperium/tonic)ã‚’ä½¿ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚tonicã‚’ä½¿ã†åˆ©ç‚¹ã¨ã—ã¦ã€protobuf/grpcã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ¥ã€…ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒãªãã€`cargo build`ã®ä¸­ã§è‡ªå‹•çš„ã«ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã¨ã“ã‚ã«ã‚ã‚Šã¾ã™ã€‚

ä»Šå›ã¯ã“ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ã„ã¾ã™ã€‚

```protobuf
syntax = "proto3";

package foo;

service Foo {
    rpc echo(EchoRequest) returns (EchoReply);
}

message EchoRequest {
   string name = 1;
}

message EchoReply {
    string message = 1;
}
```

Client,Serverã®å®Ÿè£…ã¯[ã“ã“](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/tree/8a03300feb82d6c334d02069dd5f64a990297c39)ã‚’è¦‹ã¦ãã ã•ã„ã€‚

## `metrics-rs`ã¨ã¯ï¼Ÿ

![](/images/0bfa0a31aa6577/metrics-rs.png)

[metrics](https://github.com/metrics-rs/metrics)ã¯Rustè¨€èªã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²ã—ãŸã‚Šã€Prometheusç”¨ã®ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ç°¡å˜ã«ä½œã‚‹ã“ã¨ãŒã§ãã‚‹crateã§ã™ã€‚

`metrics`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ä»¥ä¸‹ã®crateãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯`metrics`ã¨`metrics-exporter-prometheus`ã‚’ä½¿ã„ã¾ã™ã€‚
* [metrics](https://github.com/metrics-rs/metrics/tree/main/metrics): ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ã®ãŸã‚ã®traitã‚„ãƒã‚¯ãƒ­ã‚’æä¾›ã™ã‚‹ã€‚[log](https://docs.rs/log/latest/log/)ã‚¯ãƒ¬ãƒ¼ãƒˆã¿ãŸã„ãªå­˜åœ¨ã€‚
* [metrics-tracing-context](): [tracing](https://tracing.rs/tracing/)[^2]ã¨ã®é€£æº
* [metrics-util](https://github.com/metrics-rs/metrics/tree/main/metrics-util): metricså†…éƒ¨ã§ä½¿ã‚ã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
* [metrics-macros](https://github.com/metrics-rs/metrics/tree/main/metrics-macros): metricså†…éƒ¨ã§ä½¿ã‚ã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
* [metrics-exporter-tcp](https://github.com/metrics-rs/metrics/tree/main/metrics-exporter-tcp): TCPç”¨ã®exporter
* [metrics-exporter-prometheus](https://github.com/metrics-rs/metrics/tree/main/metrics-exporter-prometheus): Prometheusäº’æ›ã®exporter

## `metrics-rs`ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²ã™ã‚‹

`metrics`ã¯ä»¥ä¸‹ã®3ã¤ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

* Histgram
    ```rust
    histogram!("some_metric_name", 34.3);
    ```
* Gauge
    ```rust
    gauge!("some_metric_name", 42.2222);
    ```
* Counter
    ```rust
    counter!("some_metric_name", 12);
    ```

ã¾ãŸã€å…¨ã¦ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã‚¿ã‚¤ãƒ—ã«å…±é€šã—ã¦ã€ä»»æ„ã®key/valueã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã“ã§è¿½åŠ ã—ãŸkey/valueã¯Grafanaå´ã§å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ã‚¯ã‚¨ãƒªã§ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
histogram!("some_metric_name", 34.3, "key" => "value");
```

ä»Šå›ã¯Serverå´ã®`echo`APIã®ãƒãƒ³ãƒ‰ãƒ©å†…ã§ä»¥ä¸‹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²ã—ã¦ã„ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ã¯[ã“ã¡ã‚‰](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/blob/main/server/src/main.rs#L39-L58)

```rust
// "echo" APIã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã®è¨ˆæ¸¬
histogram!("foo_histgram", now.elapsed(), "api" => "echo", "result" => "ok");

// ã¨ã‚Šã‚ãˆãšå¢—ãˆã¦ã„ãã ã‘ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
increment_counter!("foo_counter");

// ã¨ã‚Šã‚ãˆãšå¢—ãˆã¦ã„ãã ã‘ã®ã‚²ãƒ¼ã‚¸
increment_gauge!("foo_gauge", 10.0);
```

## Prometheusäº’æ›ã®exporterã‚’ç«‹ã¦ã‚‹

[metrics-exporter-prometheus](https://github.com/metrics-rs/metrics/tree/main/metrics-exporter-prometheus)ã‚’ä½¿ã†ã¨ã€ãŸã£ãŸä¸€è¡Œã§Prometheusäº’æ›ã®exporterã‚’ç°¡å˜ã«ç«‹ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
metrics_exporter_prometheus::PrometheusBuilder::new().install()?;
```

ã“ã®ä¸€è¡Œã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¸­ã§å°ã•ã„httpã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã€JSONã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```
git clone git@github.com:yukinarit/rust-k8s-grpc-metrics-example.git
cd rust-k8s-grpc-metrics-example/server
cargo run
```

`server`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`0.0.0.0:9000`ã‚’LISTENã—ãŸhttpã‚µãƒ¼ãƒãƒ¼ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã—ãŸã€‚

```
$ netstat -an | grep LISTEN | grep 9000
tcp4       0      0  *.9000                 *.*                    LISTEN
```

ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦curlã™ã‚‹ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚

```
$ curl http://localhost:9000/
# TYPE foo_counter counter
foo_counter 120

# TYPE foo_gauge gauge
foo_gauge 1200

# TYPE foo_histgram summary
foo_histgram{api="echo",result="ok",quantile="0"} 0.000011611
foo_histgram{api="echo",result="ok",quantile="0.5"} 0.00003000039410022207
foo_histgram{api="echo",result="ok",quantile="0.9"} 0.00005798651714158709
foo_histgram{api="echo",result="ok",quantile="0.95"} 0.00007568731078309839
foo_histgram{api="echo",result="ok",quantile="0.99"} 0.0001138418862207591
foo_histgram{api="echo",result="ok",quantile="0.999"} 0.0001233727823801684
foo_histgram{api="echo",result="ok",quantile="1"} 0.00048648716917468264
foo_histgram_sum{api="echo",result="ok"} 0.005295823000000002
foo_histgram_count{api="echo",result="ok"} 120
```

## gRPCã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Kubernetesä¸Šã§å‹•ã‹ã™

```
cd rust-k8s-grpc-metrics-example
```

* [`server.yml`](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/blob/main/server.yml): Deploymentã§`server`ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
* [`client.yml`](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/blob/main/client.yml): CronJobã§`server`ã«å¯¾ã—ã¦1ç§’ã«ä¸€å›"echo" APIã‚’callã™ã‚‹
* [`prometheus.yml`](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/blob/main/prometheus.yml): Prometheusã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
* [`grafana.yml`](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/blob/main/grafana.yml): Grafanaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

## Prometheusã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹

Prometheusã«ã¯[kubernetes_sd_config](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config)[^3]ã¨ã„ã†Kubernetesä¸Šã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’Service Discoveryã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ä½œã£ãŸ`server-metrics-service`ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®yamlã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml
      - job_name: kubernetes-service
        scheme: http
        kubernetes_sd_configs:
        - role: endpoints
        relabel_configs:
        - source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_service_name
          regex: default;kubernetes
          action: drop
        - source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_service_name
          - __meta_kubernetes_endpoint_port_name
          regex: default;server-metrics-service;metrics
          action: keep
```

## Grafanaã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹

Grafanaã§è‡ªåˆ†ã§è¨˜éŒ²ã—ãŸ`foo_histgram`, `foo_counter`, `foo_gauge`ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¨­å®šã®è©³ç´°ã¯çŸ¥ã‚ŠãŸã„äººã¯ã€[dashboard.json](https://github.com/yukinarit/rust-k8s-grpc-metrics-example/blob/main/dashboard.json)ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
![](/images/0bfa0a31aa6577/dashboard.png)

## ãŠã‚ã‚Šã«

ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«é–“ã«åˆã‚ã›ã‚‹ãŸã‚ã«èª¬æ˜ãŒã‹ãªã‚Šé›‘ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸw 

ã“ã®è¨˜äº‹ä½œæˆã«ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹äººã¯å‚ç…§ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

![](/images/0bfa0a31aa6577/repo.png =500x)

[^1]: [Rustã®gRPCãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://qiita.com/watawuwu/items/114e2674736e44d4b16d#rust-%E3%81%AE-grpc-%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA)
[^2]: [Rust: Into tracing world](https://qiita.com/gemhung/items/bd4c4617b58250689f47)
[^3]: [Prometheus ã®ç›£è¦–å¯¾è±¡ã‚’ ServiceDiscovery ã§å‹•çš„ã«è¨­å®šã™ã‚‹](https://christina04.hatenablog.com/entry/prometheus-service-discovery)